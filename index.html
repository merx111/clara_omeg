<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>P2P Omegle</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #0f0; padding: 20px; }
    #chat { border: 1px solid #0f0; height: 300px; overflow: auto; padding: 10px; margin-bottom: 10px; }
    input { width: 100%; padding: 10px; }
  </style>
</head>
<body>
  <h1>P2P Omegle</h1>
  <div id="chat"></div>
  <input id="message" placeholder="Escribe y presiona Enter..." />
  <script>
    const JSONBIN_SECRET = '$2a$10$W7r2d0gmDZE45aqzwLFbTumNYrlgnya.eify2ghIr2Ebrf0aupxWu';
    const BIN_ID = '684ae0ef8561e97a502305dd'; // Puedes generarlo aleatoriamente para cada par
    const isCaller = location.hash !== "#join";

    const pc = new RTCPeerConnection();
    let channel;

    const chat = document.getElementById('chat');
    const input = document.getElementById('message');

    function log(msg) {
      chat.innerHTML += `<div>${msg}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    // Enviar y recibir mensajes
    function setupChannelEvents(c) {
      c.onmessage = e => log("Stranger: " + e.data);
      input.onkeypress = e => {
        if (e.key === "Enter") {
          log("You: " + input.value);
          c.send(input.value);
          input.value = "";
        }
      };
    }

    // Señalización via JSONBin
    async function writeBin(data) {
      await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Master-Key": JSONBIN_SECRET
        },
        body: JSON.stringify(data)
      });
    }

    async function readBin() {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        headers: { "X-Master-Key": JSONBIN_SECRET }
      });
      const { record } = await res.json();
      return record;
    }

    async function waitForAnswer() {
      while (true) {
        const bin = await readBin();
        if (bin.answer) {
          await pc.setRemoteDescription(new RTCSessionDescription(bin.answer));
          break;
        }
        await new Promise(r => setTimeout(r, 1000));
      }
    }

    async function waitForOffer() {
      while (true) {
        const bin = await readBin();
        if (bin.offer) {
          await pc.setRemoteDescription(new RTCSessionDescription(bin.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          await writeBin({ ...bin, answer });
          break;
        }
        await new Promise(r => setTimeout(r, 1000));
      }
    }

    if (isCaller) {
      log("Esperando a un desconocido...");

      channel = pc.createDataChannel("chat");
      setupChannelEvents(channel);

      pc.onicecandidate = async e => {
        if (e.candidate === null) {
          await writeBin({ offer: pc.localDescription });
        }
      };

      pc.createOffer().then(offer => pc.setLocalDescription(offer));
      waitForAnswer();
    } else {
      log("Conectando con un extraño...");

      pc.ondatachannel = e => {
        channel = e.channel;
        setupChannelEvents(channel);
      };

      pc.onicecandidate = async e => {
        if (e.candidate === null) {
          const existing = await readBin();
          await writeBin({ ...existing, answer: pc.localDescription });
        }
      };

      waitForOffer();
    }
  </script>
</body>
</html>
