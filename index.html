<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>clara omeg</title>
  <!-- Fuente bonita -->
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; background: #111; color: #eee;
      font-family: sans-serif; height: 100vh;
      display: flex; justify-content: center;
      align-items: center; text-align: center;
    }
    .screen {
      width: 100%; max-width: 480px;
      padding: 1rem; background: #222;
      border-radius: 8px; overflow-y: auto;
      max-height: 90vh;
    }
    h1 {
      font-family: 'Pacifico', cursive;
      font-size: 2.5rem; margin-bottom: 1rem;
    }
    input, button, select {
      width: 100%; padding: .75rem;
      margin: .5rem 0; font-size: 1rem;
      border: none; border-radius: 6px;
    }
    button {
      background: crimson; color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #555; cursor: default;
    }
    .half { width: 48%; display: inline-block; }
    .half button { width: 100%; }
    #authLog, #statusP, #logP, #statusC, #logC {
      font-size: .9rem; min-height: 1.2rem; margin-top: .5rem;
    }
    #authLog { color: #f88; }
    #statusP, #statusC { color: #ccc; }
    #logP, #logC    { color: #f88; }
    video {
      width: 100%; border-radius: 8px;
      background: black; margin: .5rem 0;
      transition: filter .3s, transform .3s;
    }
    #videos { display: flex; gap: .5rem; flex-wrap: wrap; }
    #videos video { width: 48%; max-width: 200px; }
    #filters { margin-top: 1rem; text-align: left; }
  </style>
</head>
<body>

  <!-- AUTH SCREEN -->
  <div id="auth-screen" class="screen">
    <h1>clara omeg</h1>
    <input id="inpUser" type="text" placeholder="Usuario" autocomplete="username">
    <input id="inpPass" type="password" placeholder="Contraseña" autocomplete="current-password">
    <div class="half"><button id="btnRegister">Registrar</button></div>
    <div class="half"><button id="btnLogin">Iniciar Sesión</button></div>
    <div id="authLog"></div>
  </div>

  <!-- PREVIEW SCREEN -->
  <div id="preview-screen" class="screen hidden">
    <h1>Tu Cámara</h1>
    <video id="video-local-preview" autoplay muted></video>
    <div id="filters">
      <label for="filter-select">Filtro:</label>
      <select id="filter-select">
        <option value="none">Ninguno</option>
        <option value="grayscale(100%)">Escala de grises</option>
        <option value="sepia(100%)">Sepia</option>
        <option value="invert(100%)">Invertir</option>
        <option value="contrast(200%)">Contraste ↑</option>
        <option value="mirror">Espejo</option>
        <option value="zoom">Zoom (cara grande)</option>
      </select>
    </div>
    <div id="statusP"></div>
    <div id="logP"></div>
    <button id="btnBegin">Comenzar</button>
  </div>

  <!-- CHAT SCREEN -->
  <div id="chat-screen" class="screen hidden">
    <h1>Conectando…</h1>
    <div id="videos">
      <video id="video-local" autoplay muted></video>
      <video id="video-remote" autoplay></video>
    </div>
    <div id="statusC"></div>
    <div id="logC"></div>
    <button id="btnSkip" disabled>Skip</button>
  </div>

<script>
  // — CONFIG JSONBin —
  const API_KEY = '$2a$10$W7r2d0gmDZE45aqzwLFbTumNYrlgnya.eify2ghIr2Ebrf0aupxWu';
  const BIN_ID  = '684abe418561e97a5022f0ef';
  const TIMEOUT = 20000;

  // — DOM Refs —
  const authSC     = document.getElementById('auth-screen');
  const previewSC  = document.getElementById('preview-screen');
  const chatSC     = document.getElementById('chat-screen');

  const inpUser    = document.getElementById('inpUser');
  const inpPass    = document.getElementById('inpPass');
  const btnRegister= document.getElementById('btnRegister');
  const btnLogin   = document.getElementById('btnLogin');
  const authLog    = document.getElementById('authLog');

  const vidPrev    = document.getElementById('video-local-preview');
  const filterSel  = document.getElementById('filter-select');
  const btnBegin   = document.getElementById('btnBegin');
  const statusP    = document.getElementById('statusP');
  const logP       = document.getElementById('logP');

  const vidLocal   = document.getElementById('video-local');
  const vidRemote  = document.getElementById('video-remote');
  const btnSkip    = document.getElementById('btnSkip');
  const statusC    = document.getElementById('statusC');
  const logC       = document.getElementById('logC');

  // — P2P & STATE —
  const peer       = new Peer();
  let localStream  = null;
  let currentCall  = null;

  // — JSONBin helpers init/fetch/update —
  async function fetchBin() {
    let res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { 'X-Master-Key': API_KEY }
    });
    if (!res.ok) {
      console.error('fetchBin status', res.status);
      return { users: {}, queue: {} };
    }
    let { record } = await res.json();
    if (!record || typeof record !== 'object') record = {};
    if (typeof record.users !== 'object') record.users = {};
    if (typeof record.queue !== 'object') record.queue = {};
    return record;
  }
  async function updateBin(record) {
    console.log('updateBin', record);
    let res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': API_KEY
      },
      body: JSON.stringify(record)
    });
    if (!res.ok) console.error('updateBin status', res.status);
  }

  // — AUTH FUNCTIONS —
  async function registerUser(nick, pass) {
    authLog.textContent = '🔄 Registrando…';
    try {
      const bin = await fetchBin();
      if (bin.users[nick]) {
        authLog.textContent = '❌ Usuario ya existe.';
        return false;
      }
      bin.users[nick] = pass;
      await updateBin(bin);
      authLog.textContent = '✅ Registrado.';
      return true;
    } catch (e) {
      console.error(e);
      authLog.textContent = '❌ Error: ' + e.message;
      return false;
    }
  }
  async function loginUser(nick, pass) {
    authLog.textContent = '🔄 Comprobando…';
    try {
      const bin = await fetchBin();
      if (bin.users[nick] === pass) {
        authLog.textContent = '✅ Login correcto.';
        return true;
      } else {
        authLog.textContent = '❌ Credenciales incorrectas.';
        return false;
      }
    } catch (e) {
      console.error(e);
      authLog.textContent = '❌ Error: ' + e.message;
      return false;
    }
  }

  btnRegister.onclick = async () => {
    const u = inpUser.value.trim(), p = inpPass.value;
    if (!u || !p) { authLog.textContent = '❗ Rellena ambos campos.'; return; }
    await registerUser(u, p);
  };
  btnLogin.onclick = async () => {
    const u = inpUser.value.trim(), p = inpPass.value;
    if (!u || !p) { authLog.textContent = '❗ Rellena ambos campos.'; return; }
    if (await loginUser(u, p)) {
      authSC.classList.add('hidden');
      previewSC.classList.remove('hidden');
      initStream();
    }
  };

  // — STREAM & FILTERS —
  function setStatusP(txt) { statusP.textContent = txt; }
  function logPmsg(txt)   { logP.textContent = txt; }
  async function initStream() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      vidPrev.srcObject = localStream;
      setStatusP('Stream listo');
    } catch {
      alert('Permite cámara y micrófono.');
    }
  }
  filterSel.onchange = () => {
    const v = filterSel.value;
    if (v === 'mirror') {
      vidPrev.style.transform = 'scaleX(-1)';
    } else if (v === 'zoom') {
      vidPrev.style.transform = 'scale(2)';
      vidPrev.style.transformOrigin = 'center center';
    } else {
      vidPrev.style.transform = '';
      vidPrev.style.filter = v;
    }
  };

  btnBegin.onclick = async () => {
    previewSC.classList.add('hidden');
    chatSC.classList.remove('hidden');
    await clearQueue();
    await enterQueue();
    startRefreshQueue();
    await joinRandom();
  };

  // — QUEUE w/ timestamps —
  async function clearQueue() {
    const bin = await fetchBin();
    bin.queue = {};
    await updateBin(bin);
  }
  async function enterQueue() {
    const bin = await fetchBin();
    const now = Date.now();
    Object.entries(bin.queue).forEach(([id, ts]) => { if (now - ts > TIMEOUT) delete bin.queue[id]; });
    bin.queue[peer.id] = now;
    await updateBin(bin);
    statusC.textContent = `En cola: ${Object.keys(bin.queue).length}`;
  }
  async function leaveQueue() {
    const bin = await fetchBin();
    delete bin.queue[peer.id];
    await updateBin(bin);
  }
  function startRefreshQueue() {
    setInterval(enterQueue, TIMEOUT / 2);
  }
  async function joinRandom() {
    const bin = await fetchBin();
    const now = Date.now();
    Object.entries(bin.queue).forEach(([id, ts]) => { if (now - ts > TIMEOUT) delete bin.queue[id]; });
    await updateBin(bin);
    const others = Object.keys(bin.queue).filter(id => id !== peer.id);
    statusC.textContent = `Disponibles: ${others.length}`;
    if (!others.length) { logC('Nadie disponible', false); return; }
    startCall(others[Math.floor(Math.random() * others.length)]);
  }

  // — P2P & CALL UI —
  function setStatusC(txt) { statusC.textContent = txt; }
  function logC(txt, err = true) { logC.textContent = txt; console[err ? 'error' : 'log'](txt); }

  function startCall(remoteID) {
    if (currentCall) currentCall.close();
    const call = peer.call(remoteID, localStream);
    setupCall(call);
    btnSkip.disabled = false;
  }
  function setupCall(call) {
    currentCall = call;
    call.on('stream', s => vidRemote.srcObject = s);
    call.on('close', cleanup);
    call.on('error', cleanup);
  }
  function cleanup() {
    vidRemote.srcObject = null;
    currentCall = null;
    btnSkip.disabled = true;
    setStatusC('Conexión terminada');
  }

  peer.on('open', id => setStatusC('ID: ' + id));
  peer.on('call', call => {
    if (currentCall) call.close();
    call.answer(localStream);
    setupCall(call);
    btnSkip.disabled = false;
  });

  btnSkip.onclick = async () => {
    cleanup();
    await leaveQueue();
    await enterQueue();
    await joinRandom();
  };

  window.addEventListener('beforeunload', leaveQueue);
  window.addEventListener('pagehide',    leaveQueue);
  window.addEventListener('unload',      leaveQueue);
</script>
</body>
</html>
