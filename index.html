<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>clara omeg</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      text-align: center;
    }
    #status { margin: .5rem; font-size: .9rem; color: #ccc; }
    #log    { margin: .5rem; font-size: .9rem; color: #f88; min-height: 1.2rem; }
    h1 {
      font-family: 'Pacifico', cursive;
      font-size: 3rem;
      margin: 1rem 0;
    }
    video {
      background: black;
      border-radius: 8px;
      transition: filter .3s, transform .3s;
    }
    #start-screen video,
    #chat-screen video {
      width: 80vw;
      max-width: 640px;
      height: auto;
    }
    #chat-screen #videos {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    button {
      padding: 1rem 2rem;
      margin: .5rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      background: crimson;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #555;
      cursor: default;
    }
    #filters {
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    select {
      padding: .4rem;
      font-size: 1rem;
      border-radius: 4px;
      border: none;
      background: #333;
      color: #eee;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div id="status">Inicializando…</div>
  <div id="log"></div>

  <!-- PANTALLA INICIAL -->
  <div id="start-screen">
    <h1>clara omeg</h1>
    <video id="video-local-start" autoplay muted></video>
    <div id="filters">
      <label for="filter-select">Filtro:</label>
      <select id="filter-select">
        <option value="none">Ninguno</option>
        <option value="grayscale(100%)">Escala de grises</option>
        <option value="sepia(100%)">Sepia</option>
        <option value="invert(100%)">Invertir</option>
        <option value="contrast(200%)">Contraste ↑</option>
        <option value="mirror">Espejo</option>
        <option value="zoom">Zoom (cara grande)</option>
      </select>
    </div>
    <button id="btnStart">Comenzar</button>
  </div>

  <!-- PANTALLA DE CHAT -->
  <div id="chat-screen" class="hidden">
    <div id="videos">
      <video id="video-local" autoplay muted></video>
      <video id="video-remote" autoplay></video>
    </div>
    <button id="btnSkip" disabled>Skip</button>
  </div>

  <script>
    // — CONFIG JSONBin —
    const API_KEY = '$2a$10$W7r2d0gmDZE45aqzwLFbTumNYrlgnya.eify2ghIr2Ebrf0aupxWu';
    const BIN_ID  = '684abe418561e97a5022f0ef';
    // tiempo de inactividad tras el cual se purga (20 s)
    const TIMEOUT = 20_000;

    // — DOM —
    const status       = document.getElementById('status');
    const logDiv       = document.getElementById('log');
    const startScreen  = document.getElementById('start-screen');
    const chatScreen   = document.getElementById('chat-screen');
    const vidStart     = document.getElementById('video-local-start');
    const vidLocal     = document.getElementById('video-local');
    const vidRemote    = document.getElementById('video-remote');
    const filterSelect = document.getElementById('filter-select');
    const btnStart     = document.getElementById('btnStart');
    const btnSkip      = document.getElementById('btnSkip');

    // — P2P & STREAM —
    const peer       = new Peer();
    let myID         = '';
    let localStream  = null;
    let currentCall  = null;

    function setStatus(txt) {
      status.textContent = txt;
    }
    function log(txt, isError = true) {
      logDiv.textContent = txt;
      console[isError ? 'error' : 'log'](txt);
    }

    // — JSONBin helpers (objeto id→timestamp) —
    async function fetchBin() {
      setStatus('Obteniendo cola…');
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        headers: {'X-Master-Key': API_KEY}
      });
      if (!res.ok) {
        log('Error fetchBin ' + res.status);
        return {};
      }
      const { record } = await res.json();
      // aseguramos que sea objeto
      return (record && typeof record === 'object') ? record : {};
    }
    async function updateBin(obj) {
      setStatus('Actualizando cola…');
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': API_KEY
        },
        body: JSON.stringify(obj)
      });
      if (!res.ok) log('Error updateBin ' + res.status);
    }

    // — MANTENIMIENTO de cola con timestamps —
    async function enterQueue() {
      const bin = await fetchBin();
      // purgar inactivos
      const now = Date.now();
      for (const [id, ts] of Object.entries(bin)) {
        if (now - ts > TIMEOUT) delete bin[id];
      }
      // actualizar mi timestamp
      bin[myID] = now;
      await updateBin(bin);
      setStatus(`En cola. Usuarios activos: ${Object.keys(bin).length}`);
    }

    async function leaveQueue() {
      const bin = await fetchBin();
      delete bin[myID];
      await updateBin(bin);
      setStatus('Saliste de la cola');
    }

    async function joinRandom() {
      const bin = await fetchBin();
      // purgar y actualizar
      const now = Date.now();
      for (const [id, ts] of Object.entries(bin)) {
        if (now - ts > TIMEOUT) delete bin[id];
      }
      await updateBin(bin);
      // emparejar
      const others = Object.keys(bin).filter(id => id !== myID);
      setStatus(`Usuarios disponibles: ${others.length}`);
      if (!others.length) {
        log('Nadie más conectado', false);
        return;
      }
      const peerID = others[Math.floor(Math.random() * others.length)];
      startCall(peerID);
    }

    // — P2P CALLS —
    function startCall(remoteID) {
      log(`Llamando a ${remoteID}`, false);
      if (currentCall) currentCall.close();
      currentCall = peer.call(remoteID, localStream);
      setupCall(currentCall);
      btnSkip.disabled = false;
    }
    function setupCall(call) {
      call.on('stream', stream => {
        vidRemote.srcObject = stream;
        setStatus('Conectado con ' + call.peer);
      });
      call.on('close', cleanupCall);
      call.on('error', err => {
        log('Error en la llamada: ' + err, true);
        cleanupCall();
      });
    }
    function cleanupCall() {
      vidRemote.srcObject = null;
      currentCall = null;
      btnSkip.disabled = true;
      setStatus('Conexión finalizada');
    }

    // — PEERJS EVENTS —
    peer.on('open', id => {
      myID = id;
      setStatus('Tu ID: ' + id);
    });
    peer.on('call', call => {
      log('Llamada entrante de ' + call.peer, false);
      if (currentCall) call.close();
      currentCall = call;
      call.answer(localStream);
      setupCall(call);
      btnSkip.disabled = false;
    });

    // — LOCAL STREAM & FILTERS —
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        vidStart.srcObject = stream;
        vidLocal.srcObject  = stream;
        setStatus('Stream listo. Tu ID: ' + myID);
        // cada 10 s refrescamos mi timestamp
        setInterval(enterQueue, TIMEOUT / 2);
      })
      .catch(err => {
        log('No access: ' + err.message);
        alert('Permite cámara y micrófono.');
      });

    filterSelect.addEventListener('change', () => {
      const s1 = vidStart.style, s2 = vidLocal.style, val = filterSelect.value;
      if (val === 'mirror') {
        [s1, s2].forEach(s => { s.transform = 'scaleX(-1)'; s.filter = ''; });
      } else if (val === 'zoom') {
        [s1, s2].forEach(s => {
          s.transform = 'scale(2)';
          s.transformOrigin = 'center center';
          s.filter = '';
        });
      } else {
        [s1, s2].forEach(s => { s.transform = ''; s.filter = val; });
      }
    });

    // — BOTONES —
    btnStart.onclick = async () => {
      btnStart.disabled = true;
      startScreen.classList.add('hidden');
      chatScreen.classList.remove('hidden');
      await enterQueue();
      await joinRandom();
    };
    btnSkip.onclick = async () => {
      cleanupCall();
      await leaveQueue();
      await enterQueue();
      await joinRandom();
    };

    // — Al cerrar, nos borramos de la cola de forma explícita —
    window.addEventListener('beforeunload', leaveQueue);
    window.addEventListener('pagehide',    leaveQueue);
    window.addEventListener('unload',      leaveQueue);

  </script>
</body>
</html>
