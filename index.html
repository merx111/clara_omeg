<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>clara omeg</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    .screen {
      width: 100%;
      max-width: 480px;
      padding: 1rem;
      overflow-y: auto;
    }
    h1 {
      font-family: 'Pacifico', cursive;
      font-size: 2.5rem;
      margin-bottom: 1rem;
    }
    input {
      width: 100%;
      padding: .75rem;
      margin: .5rem 0;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
    }
    button {
      width: 100%;
      padding: 1rem;
      margin: .5rem 0;
      font-size: 1.1rem;
      border: none;
      border-radius: 6px;
      background: crimson;
      color: white;
      cursor: pointer;
    }
    .half { width: 48%; display: inline-block; }
    .hidden { display: none; }
    video {
      width: 100%;
      border-radius: 8px;
      background: black;
      margin: .5rem 0;
    }
    #status, #statusC { font-size: .9rem; color: #ccc; margin: .5rem 0; }
    #log, #logC    { font-size: .9rem; color: #f88; min-height: 1.2rem; }
    #videos { display: flex; gap: .5rem; justify-content: center; flex-wrap: wrap; }
    #videos video { width: 48%; max-width: 200px; }
  </style>
</head>
<body>

  <!-- REGISTER / LOGIN -->
  <div id="auth-screen" class="screen">
    <h1>clara omeg</h1>
    <input id="inpUser" type="text" placeholder="Usuario" autocomplete="username">
    <input id="inpPass" type="password" placeholder="Contraseña" autocomplete="current-password">
    <div class="half"><button id="btnRegister">Registrar</button></div>
    <div class="half"><button id="btnLogin">Iniciar Sesión</button></div>
    <div id="authLog"></div>
  </div>

  <!-- PREVIEW -->
  <div id="preview-screen" class="screen hidden">
    <h1>Tu Cámara</h1>
    <video id="video-local-preview" autoplay muted></video>
    <div id="status">Esperando…</div>
    <div id="log"></div>
    <button id="btnBegin">Comenzar</button>
  </div>

  <!-- CHAT -->
  <div id="chat-screen" class="screen hidden">
    <h1>Conectando…</h1>
    <div id="videos">
      <video id="video-local" autoplay muted></video>
      <video id="video-remote" autoplay></video>
    </div>
    <div id="statusC">Inicializando…</div>
    <div id="logC"></div>
    <button id="btnSkip" disabled>Skip</button>
  </div>

<script>
  // — CONFIG JSONBin —
  const API_KEY = '$2a$10$W7r2d0gmDZE45aqzwLFbTumNYrlgnya.eify2ghIr2Ebrf0aupxWu';
  const BIN_ID  = '684abe418561e97a5022f0ef';
  const TIMEOUT = 20_000;

  // — DOM refs —
  const authSC    = document.getElementById('auth-screen');
  const previewSC = document.getElementById('preview-screen');
  const chatSC    = document.getElementById('chat-screen');

  const inpUser   = document.getElementById('inpUser');
  const inpPass   = document.getElementById('inpPass');
  const btnRegister = document.getElementById('btnRegister');
  const btnLogin    = document.getElementById('btnLogin');
  const authLog     = document.getElementById('authLog');

  const vidPrev   = document.getElementById('video-local-preview');
  const btnBegin  = document.getElementById('btnBegin');
  const statusP   = document.getElementById('status');
  const logP      = document.getElementById('log');

  const vidLocal  = document.getElementById('video-local');
  const vidRemote = document.getElementById('video-remote');
  const btnSkip   = document.getElementById('btnSkip');
  const statusC   = document.getElementById('statusC');
  const logC      = document.getElementById('logC');

  // — P2P & STATE —
  const peer       = new Peer();
  let myID         = '';
  let localStream  = null;
  let currentCall  = null;
  let userNick     = '';

  // — UTILITIES JSONBin (record = { users: {...}, queue: {...} }) —
  async function fetchBin() {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: {'X-Master-Key': API_KEY}
    });
    if (!res.ok) return { users:{}, queue:{} };
    const { record } = await res.json();
    return {
      users: (record.users instanceof Object) ? record.users : {},
      queue: (record.queue instanceof Object) ? record.queue : {}
    };
  }
  async function updateBin(data) {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method:'PUT',
      headers:{
        'Content-Type':'application/json',
        'X-Master-Key':API_KEY
      },
      body: JSON.stringify(data)
    });
  }

  // — AUTH —
  async function registerUser(nick, pass) {
    const bin = await fetchBin();
    if (bin.users[nick]) return false;
    bin.users[nick] = pass;
    await updateBin(bin);
    return true;
  }
  async function loginUser(nick, pass) {
    const bin = await fetchBin();
    return bin.users[nick] === pass;
  }

  btnRegister.onclick = async () => {
    const u = inpUser.value.trim(), p = inpPass.value;
    if (!u || !p) { authLog.textContent='Usuario y clave obligatorios'; return; }
    if (await registerUser(u,p)) {
      authLog.textContent = 'Registrado con éxito. Ahora inicia sesión.';
    } else {
      authLog.textContent = 'El usuario existe.';
    }
  };

  btnLogin.onclick = async () => {
    const u = inpUser.value.trim(), p = inpPass.value;
    if (await loginUser(u,p)) {
      userNick = u;
      authSC.classList.add('hidden');
      previewSC.classList.remove('hidden');
      initStream();
    } else {
      authLog.textContent = 'Credenciales inválidas';
    }
  };

  // — STREAM & PREVIEW —
  function setStatus(txt){ statusP.textContent = txt; }
  function log(txt){ logP.textContent = txt; }
  async function initStream() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
      vidPrev.srcObject = localStream;
    } catch {
      alert('Permite cámara y micrófono.');
    }
  }

  btnBegin.onclick = async () => {
    previewSC.classList.add('hidden');
    chatSC.classList.remove('hidden');
    await clearQueue();      // limpiar cola de IDs previos
    await enterQueue();      // entrar a cola
    startRefreshQueue();     // mantener vivo en cola
    await joinRandom();      // emparejar
  };

  // — QUEUE w/ timestamps —
  async function clearQueue() {
    const bin = await fetchBin();
    bin.queue = {};
    await updateBin(bin);
  }
  async function enterQueue() {
    const bin = await fetchBin();
    const now = Date.now();
    // purga
    for (let [id,ts] of Object.entries(bin.queue)) {
      if (now - ts > TIMEOUT) delete bin.queue[id];
    }
    bin.queue[peer.id] = now;
    await updateBin(bin);
    setStatusC(`En cola: ${Object.keys(bin.queue).length}`);
  }
  async function leaveQueue() {
    const bin = await fetchBin();
    delete bin.queue[peer.id];
    await updateBin(bin);
  }
  function startRefreshQueue() {
    setInterval(enterQueue, TIMEOUT/2);
  }
  async function joinRandom() {
    const bin = await fetchBin();
    const now = Date.now();
    for (let [id,ts] of Object.entries(bin.queue)) {
      if (now - ts > TIMEOUT) delete bin.queue[id];
    }
    await updateBin(bin);
    const others = Object.keys(bin.queue).filter(id=>id!==peer.id);
    setStatusC(`Disponibles: ${others.length}`);
    if (!others.length) { logC('Nadie disponible', false); return; }
    startCall(others[Math.floor(Math.random()*others.length)]);
  }

  // — P2P CALLS & UI —
  function setStatusC(txt){ statusC.textContent = txt; }
  function logC(txt, isError=true){ logC.textContent=txt; console[isError?'error':'log'](txt) }
  function startCall(remoteID) {
    currentCall?.close();
    const call = peer.call(remoteID, localStream);
    setupCall(call);
    btnSkip.disabled = false;
  }
  function setupCall(call) {
    currentCall = call;
    call.on('stream', s=>vidRemote.srcObject=s);
    call.on('close',cleanup);
    call.on('error',cleanup);
  }
  function cleanup() {
    vidRemote.srcObject = null;
    currentCall = null;
    btnSkip.disabled = true;
  }

  peer.on('open', id => { /* nothing */ });
  peer.on('call', call => {
    currentCall?.close();
    call.answer(localStream);
    setupCall(call);
    btnSkip.disabled = false;
  });

  btnSkip.onclick = async () => {
    cleanup();
    await leaveQueue();
    await enterQueue();
    await joinRandom();
  };

  window.addEventListener('beforeunload', leaveQueue);
  window.addEventListener('pagehide',    leaveQueue);
  window.addEventListener('unload',      leaveQueue);
</script>
</body>
</html>
