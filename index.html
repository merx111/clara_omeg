<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat de Vídeo Aleatorio</title>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    #videos {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    video {
      width: 320px;
      height: 240px;
      background: black;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      background: crimson;
      color: white;
      cursor: pointer;
    }
    button:disabled {
      background: #555;
      cursor: default;
    }
  </style>
</head>
<body>

  <h1>Chat de Vídeo Aleatorio</h1>
  <button id="btnStart">Empezar</button>
  <button id="btnSkip" disabled>Skip</button>

  <div id="videos">
    <video id="video-local" autoplay muted></video>
    <video id="video-remote" autoplay></video>
  </div>

  <script>
    // ——— CONFIGURACIÓN ———
    const API_KEY = '$2a$10$W7r2d0gmDZE45aqzwLFbTumNYrlgnya.eify2ghIr2Ebrf0aupxWu';
    const BIN_ID  = '684abe418561e97a5022f0ef';

    // ——— VARIABLES GLOBALES ———
    const peer       = new Peer();
    let myID         = '';
    let localStream  = null;
    let currentCall  = null;

    const btnStart  = document.getElementById('btnStart');
    const btnSkip   = document.getElementById('btnSkip');
    const vidLocal  = document.getElementById('video-local');
    const vidRemote = document.getElementById('video-remote');

    // ——— UTILIDADES JSONBin ———
    async function fetchBin() {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
        headers: { 'X-Master-Key': API_KEY }
      });
      if (!res.ok) throw new Error('Fetch bin error ' + res.status);
      const { record } = await res.json();
      // Si no es array, inicializarlo
      return Array.isArray(record) ? record : [];
    }

    async function updateBin(list) {
      const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Master-Key': API_KEY
        },
        body: JSON.stringify(list)
      });
      if (!res.ok) throw new Error('Update bin error ' + res.status);
    }

    // ——— LÓGICA DE EMPAREJAMIENTO ———
    async function joinRandom() {
      const waiting = await fetchBin();
      const others = waiting.filter(id => id !== myID);
      if (others.length === 0) {
        alert('No hay nadie disponible, espera un momento...');
        return;
      }
      const peerID = others[Math.floor(Math.random() * others.length)];
      startCall(peerID);
    }

    async function enterQueue() {
      const list = await fetchBin();
      if (!list.includes(myID)) {
        list.push(myID);
        await updateBin(list);
      }
    }

    async function leaveQueue() {
      const list = await fetchBin();
      const filtered = list.filter(id => id !== myID);
      await updateBin(filtered);
    }

    // ——— INICIAR LLAMADA ———
    function startCall(remoteID) {
      if (currentCall) currentCall.close();
      currentCall = peer.call(remoteID, localStream);
      setupCallHandlers(currentCall);
      btnSkip.disabled = false;
    }

    function setupCallHandlers(call) {
      call.on('stream', stream => {
        vidRemote.srcObject = stream;
      });
      call.on('close', cleanupCall);
      call.on('error', cleanupCall);
    }

    function cleanupCall() {
      vidRemote.srcObject = null;
      currentCall = null;
      btnSkip.disabled = true;
    }

    // ——— EVENTOS PEERJS ———
    peer.on('open', id => {
      myID = id;
    });

    peer.on('call', call => {
      if (currentCall) call.close();
      currentCall = call;
      call.answer(localStream);
      setupCallHandlers(call);
      btnSkip.disabled = false;
    });

    // ——— ARRANQUE DE CÁMARA ———
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        localStream = stream;
        vidLocal.srcObject = stream;
      })
      .catch(() => {
        alert('Permite el acceso a cámara y micrófono para usar la web.');
      });

    // ——— BOTONES ———
    btnStart.onclick = async () => {
      btnStart.disabled = true;
      await enterQueue();
      await joinRandom();
    };

    btnSkip.onclick = async () => {
      cleanupCall();
      await leaveQueue();
      await enterQueue();
      await joinRandom();
    };

    // Al cerrar o recargar, nos retiramos de la cola
    window.addEventListener('beforeunload', leaveQueue);
  </script>

</body>
</html>
